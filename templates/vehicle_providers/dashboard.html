{% extends 'core/base.html' %}
{% block navbar %}{% endblock %}

{% block content %}
<!-- Sidebar Toggle Button -->
<button class="dashboard-sidebar-toggle d-lg-none" id="sidebarToggle"><i class="fas fa-bars"></i></button>
<!-- Sidebar and overlay -->
<div id="sidebar" class="sidebar bg-dark text-white">
  <div class="sidebar-header d-flex align-items-center justify-content-between px-3 py-3">
    <span class="fw-bold fs-4"><i class="fas fa-charging-station me-2"></i>Provider</span>
    <button class="btn btn-sm btn-outline-light d-md-none" id="sidebarCloseBtn"><i class="fas fa-times"></i></button>
  </div>
  <nav class="nav flex-column px-2">
    <a class="nav-link text-white sidebar-link" href="#dashboard-section"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a>
    <a class="nav-link text-white sidebar-link" href="#ebikes-section"><i class="fas fa-bicycle me-2"></i>Your E-bikes</a>
    <a class="nav-link text-white sidebar-link" href="#earnings-section"><i class="fas fa-wallet me-2"></i>Earnings</a>
    <a class="nav-link text-white sidebar-link" href="#bookings-section"><i class="fas fa-calendar-check me-2"></i>Bookings</a>
    <a class="nav-link text-white sidebar-link" href="{% url 'upload_documents' %}"><i class="fas fa-file-upload me-2"></i>Upload Documents</a>
    <a class="nav-link text-white sidebar-link" href="{% url 'view_documents' %}"><i class="fas fa-file-alt me-2"></i>View Documents</a>
    <a class="nav-link text-white sidebar-link" href="{% url 'add_ebike' %}"><i class="fas fa-plus me-2"></i>Add E-bike</a>
    <a class="nav-link text-white sidebar-link" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt me-2"></i>Logout</a>
  </nav>
  <div class="sidebar-profile text-center mt-auto mb-4 px-3">
    <img id="sidebarProfileImage" src="{% if request.user.profile_image %}{{ request.user.profile_image.url }}{% else %}https://api.dicebear.com/7.x/avataaars/svg?seed={{ request.user.username }}{% endif %}"
         alt="Profile" class="rounded-circle mb-2 open-profile-modal" style="width:60px; height:60px; object-fit:cover; cursor:pointer;">
    <div id="sidebarUsername" class="fw-semibold">{{ request.user.username }}</div>
    <div id="sidebarEmail" class="text-muted small">{{ request.user.email }}</div>
    <div id="sidebarMobile" class="text-muted small">{{ request.user.mobile_number }}</div>
  </div>
</div>
<div id="sidebarOverlay" class="sidebar-overlay d-md-none"></div>

<!-- Main content with sidebar offset -->
<div class="main-content-with-sidebar">
  <div class="container-xxl py-4">
    {% if messages %}
      <div class="mb-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} mb-2" role="alert">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
    <h2 class="text-center text-white bg-primary py-3 px-2 rounded shadow-sm mb-4">
      ðŸ‘‹ Hello {{ request.user.username }} â€” Welcome to your Dashboard
    </h2>
    
    <!-- Verification Status Card -->
    {% if request.user.is_verified_provider %}
      <div class="alert alert-success text-center mb-4" role="alert">
        <i class="fas fa-check-circle fa-2x mb-2"></i>
        <h5 class="alert-heading">Account Verified!</h5>
        <p class="mb-0">Your account has been verified. You can add ebikes and manage your business on the platform.</p>
      </div>
    {% else %}
      <div class="alert alert-warning text-center mb-4" role="alert">
        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
        <h5 class="alert-heading">Account Verification Required</h5>
        <p class="mb-2">Your account is not yet verified. Please upload your documents to get verified and start adding ebikes.</p>
        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
          <a href="{% url 'upload_documents' %}" class="btn btn-warning">
            <i class="fas fa-file-upload me-1"></i>Upload Documents
          </a>
          <a href="{% url 'view_documents' %}" class="btn btn-outline-warning">
            <i class="fas fa-file-alt me-1"></i>View Status
          </a>
        </div>
      </div>
    {% endif %}
    
    <div class="row g-4 mb-4">
      <div class="col-md-6 col-12">
        <div class="card summary-card h-100 border-0 text-center">
          <div class="card-body py-4 d-flex flex-column align-items-center justify-content-center">
            <div class="icon-circle mb-3" style="background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);"><i class="fas fa-bicycle"></i></div>
            <h6 class="fw-bold text-secondary mb-1">Your E-bikes</h6>
            <h2 class="fw-bold mb-0">{{ ebikes|length }}</h2>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-12">
        <div class="card summary-card h-100 border-0 text-center">
          <div class="card-body py-4 d-flex flex-column align-items-center justify-content-center">
            <div class="icon-circle mb-3" style="background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);"><i class="fas fa-wallet"></i></div>
            <h6 class="fw-bold text-secondary mb-1">Total Earnings</h6>
            <h2 class="fw-bold mb-0">â‚¹{{ total_earnings }}</h2>
            <div class="small text-muted mt-2">Platform Charges: â‚¹{{ platform_charges }}</div>
          </div>
        </div>
      </div>
    </div>
    <div class="row g-4 w-100 mx-0" id="ebikes-section">
      <div class="card shadow-lg border-0 w-100 px-0" style="border-radius: 1.5rem;">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center sticky-ebike-header">
          <h4 class="mb-0"><i class="fas fa-bicycle me-2"></i>Your E-bikes</h4>
          <a href="{% url 'add_ebike' %}" class="btn btn-sm btn-outline-light"><i class="fas fa-plus"></i> Add</a>
        </div>
        <div class="card-body overflow-auto" style="max-height: 60vh">
          <div class="row g-4 w-100 mx-0">
            {% for ebike in ebikes %}
              <div class="col-lg-3 col-md-4 col-sm-6 col-12">
                <div class="card provider-ebike-card border-0 h-100 animated-card">
                  <div class="card-body bg-light rounded">
                    <div class="d-flex align-items-center mb-2">
                      {% if ebike.image %}
                        <img src="{{ ebike.image.url }}" alt="{{ ebike.name }}" style="width: 90px; height: 55px; object-fit: cover; border-radius: 8px;" class="me-3" />
                      {% else %}
                        <img src="https://api.dicebear.com/7.x/icons/svg?seed={{ ebike.name }}" alt="{{ ebike.name }}" style="width: 90px; height: 55px; object-fit: cover; border-radius: 8px;" class="me-3" />
                      {% endif %}
                      <h5 class="card-title text-primary mb-0 bike-name-short" title="{{ ebike.name }}"><i class="fas fa-bolt me-2"></i>{{ ebike.name }}</h5>
                    </div>
                    <p class="card-text text-muted bike-desc-short"><i class="fas fa-align-left me-1"></i>{{ ebike.description|truncatewords:15 }}</p>
                    <p class="card-text mb-1"><i class="fas fa-calendar-day me-1"></i><strong>Day Rate:</strong> â‚¹{{ ebike.price_per_day }}</p>
                    <p class="card-text mb-2"><i class="fas fa-calendar-week me-1"></i><strong>Week Rate:</strong> â‚¹{{ ebike.price_per_week }}</p>
                    {% with shown=False %}
                      {% for booking in ebike.bookings.all %}
                        {% if booking.is_approved and not shown %}
                          <div class="mt-2">
                            <span class="badge bg-danger"><i class="fas fa-lock me-1"></i>Occupied</span>
                          </div>
                          {% with True as shown %}{% endwith %}
                        {% endif %}
                      {% endfor %}
                      {% if not shown and ebike.bookings.all|length == 0 %}
                        <div class="mt-2">
                          <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Available</span>
                        </div>
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>
              </div>
            {% empty %}
            <p class="text-muted">No E-bikes registered yet.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    <div class="row g-4 mt-4 w-100 mx-0" id="bookings-section">
      <div class="card shadow-lg border-0 w-100 px-0" style="border-radius: 1.5rem;">
        <div class="card-header bg-dark text-white">
          <h4 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Active Bookings</h4>
        </div>
        <div class="card-body overflow-auto" style="max-height: 60vh">
          <div class="row g-4 w-100 mx-0">
            {% for booking in bookings %}
              <div class="col-lg-3 col-md-4 col-sm-6 col-12">
                <div class="card provider-booking-card border-0 h-100 animated-card">
                  <div class="card-body bg-light rounded">
                    <div class="d-flex align-items-center mb-2">
                      {% if booking.ebike.image %}
                        <img src="{{ booking.ebike.image.url }}" alt="{{ booking.ebike.name }}" style="width: 55px; height: 55px; object-fit: cover; border-radius: 8px;" class="me-3" />
                      {% else %}
                        <img src="https://api.dicebear.com/7.x/icons/svg?seed={{ booking.ebike.name }}" alt="{{ booking.ebike.name }}" style="width: 55px; height: 55px; object-fit: cover; border-radius: 8px;" class="me-3" />
                      {% endif %}
                      <h5 class="card-title text-primary mb-0 bike-name-short" title="{{ booking.ebike.name }}"><i class="fas fa-bolt me-2"></i>{{ booking.ebike.name }}</h5>
                    </div>
                    <p class="card-text mb-1"><i class="fas fa-user me-1"></i><strong>Rider:</strong> {{ booking.rider.username }}</p>
                    <p class="card-text mb-1"><i class="fas fa-clock me-1"></i><strong>Duration:</strong> {{ booking.start_date }} â†’ {{ booking.end_date }}</p>
                    <p class="card-text mb-1"><i class="fas fa-rupee-sign me-1"></i><strong>Amount:</strong> â‚¹{{ booking.total_price }}</p>
                    <span class="badge {% if booking.is_approved %}bg-success{% else %}bg-warning text-dark{% endif %}">
                      {% if booking.is_approved %}<i class="fas fa-check me-1"></i>Approved{% else %}<i class="fas fa-hourglass-half me-1"></i>Pending{% endif %}
                    </span>
                  </div>
                </div>
              </div>
            {% empty %}
            <p class="text-muted">You have no current bookings.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Sidebar toggle for mobile and desktop
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');
const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');
const sidebarToggle = document.getElementById('sidebarToggle');

function openSidebar() {
  sidebar.classList.add('open');
  sidebarOverlay.classList.add('show');
}
function closeSidebar() {
  sidebar.classList.remove('open');
  sidebarOverlay.classList.remove('show');
}
if (sidebarCloseBtn) sidebarCloseBtn.onclick = closeSidebar;
if (sidebarOverlay) sidebarOverlay.onclick = closeSidebar;
if (sidebarToggle) sidebarToggle.onclick = function() {
  if (window.innerWidth < 992) {
    openSidebar();
  } else {
    sidebar.classList.toggle('collapsed');
    document.querySelector('.main-content-with-sidebar').classList.toggle('collapsed');
  }
};
// Smooth scroll for sidebar links
const sidebarLinks = document.querySelectorAll('.sidebar-link');
sidebarLinks.forEach(link => {
  link.addEventListener('click', function(e) {
    const href = this.getAttribute('href');
    if (href.startsWith('#')) {
      e.preventDefault();
      const target = document.querySelector(href);
      if (target) {
        window.scrollTo({
          top: target.offsetTop - 20,
          behavior: 'smooth'
        });
        if (window.innerWidth < 992) closeSidebar();
      }
    }
  });
});
</script>
<!-- Provider Profile Edit Modal (Local) -->
<div class="modal fade" id="providerProfileModal" tabindex="-1" aria-labelledby="providerProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="providerProfileModalLabel">Edit Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="providerProfileModalBody">
        <div class="text-center py-4" id="providerProfileModalLoader">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

<script>
  // Local AJAX modal for Provider Dashboard
  (function(){
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    const modalEl = document.getElementById('providerProfileModal');
    const modalBody = document.getElementById('providerProfileModalBody');
    const modalLoader = document.getElementById('providerProfileModalLoader');
    const triggers = document.querySelectorAll('.open-profile-modal');

    async function openProviderProfileModal(e){
      if (e) e.preventDefault();
      if (!modalEl) return;
      const modal = new bootstrap.Modal(modalEl);
      modalBody.innerHTML = modalLoader ? modalLoader.outerHTML : '';
      modal.show();
      try {
        const resp = await fetch("{% url 'profile_update' %}", { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        const data = await resp.json();
        if (data.success && data.html) {
          modalBody.innerHTML = data.html;
          const form = document.getElementById('profile-update-form');
          if (form) {
            form.addEventListener('submit', async function (ev) {
              ev.preventDefault();
              const formData = new FormData(form);
              const btn = form.querySelector('button[type=\"submit\"]');
              if (btn) btn.disabled = true;
              try {
                const r = await fetch(form.getAttribute('action'), {
                  method: 'POST',
                  headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken') },
                  body: formData
                });
                if (r.ok) {
                  const ok = await r.json();
                  // Update sidebar values in-place (no reload)
                  const uEl = document.getElementById('sidebarUsername');
                  const eEl = document.getElementById('sidebarEmail');
                  const mEl = document.getElementById('sidebarMobile');
                  const imgEl = document.getElementById('sidebarProfileImage');
                  if (uEl && ok.username) uEl.textContent = ok.username;
                  if (eEl && ok.email) eEl.textContent = ok.email;
                  if (mEl && ok.mobile_number) mEl.textContent = ok.mobile_number;
                  if (imgEl && ok.profile_image_url) imgEl.src = ok.profile_image_url;
                  modalBody.insertAdjacentHTML('afterbegin', `<div class=\"alert alert-success\">${ok.message || 'Profile updated successfully!'}</div>`);
                  setTimeout(() => { const inst = bootstrap.Modal.getInstance(modalEl); if (inst) inst.hide(); }, 700);
                } else {
                  const err = await r.json();
                  modalBody.innerHTML = err.html || '<div class=\"alert alert-danger\">Failed to update profile.</div>';
                  // Rebind after re-render
                  openProviderProfileModal();
                }
              } catch (ex) {
                modalBody.insertAdjacentHTML('afterbegin', '<div class=\"alert alert-danger\">Unexpected error. Please try again.</div>');
              } finally {
                if (btn) btn.disabled = false;
              }
            });
          }
        } else {
          modalBody.innerHTML = '<div class=\"alert alert-danger\">Failed to load form.</div>';
        }
      } catch (e) {
        modalBody.innerHTML = '<div class=\"alert alert-danger\">Failed to load form.</div>';
      }
    }

    if (triggers.length) {
      triggers.forEach(t => t.addEventListener('click', openProviderProfileModal));
    }
  })();
</script>
{% endblock %}
