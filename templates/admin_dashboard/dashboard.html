{% extends 'core/base.html' %}
{% block navbar %}{% endblock %}
{% block content %}
<!-- Modern styles are now loaded globally via base.html and static/css/dashboard.css -->
<script>
  // Global fallback so inline onclick is always defined
  window.handleSidebarToggle = function() {
    try {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (window.innerWidth < 992) {
        if (sidebar) sidebar.classList.add('open');
        if (overlay) overlay.classList.add('show');
        document.body.style.overflow = 'hidden';
      } else if (sidebar) {
        sidebar.classList.toggle('collapsed');
        const main = document.querySelector('.main-content-with-sidebar') || document.querySelector('.dashboard-content');
        if (main) main.classList.toggle('collapsed');
      }
    } catch (e) {
      console.warn('Fallback handleSidebarToggle error:', e);
    }
  };
  // Ensure overlay exists for fallback
  (function(){
    if (!document.getElementById('sidebarOverlay')) {
      const ov = document.createElement('div');
      ov.id = 'sidebarOverlay';
      ov.className = 'sidebar-overlay d-md-none';
      document.body.appendChild(ov);
      ov.onclick = function(){
        const sidebar = document.getElementById('sidebar');
        if (sidebar) sidebar.classList.remove('open');
        ov.classList.remove('show');
        document.body.style.overflow = '';
      };
    }
  })();
  // Global fallback close function for X button
  window.closeAdminSidebar = function() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    if (sidebar) sidebar.classList.remove('open');
    if (overlay) overlay.classList.remove('show');
    document.body.style.overflow = '';
  };
</script>
<!-- Sidebar Toggle Button -->
<button class="dashboard-sidebar-toggle d-lg-none" id="sidebarToggle" onclick="handleSidebarToggle()"><i class="fas fa-bars"></i></button>
<!-- Sidebar and overlay -->
<div id="sidebar" class="dashboard-sidebar bg-dark text-white">
  <div class="sidebar-header d-flex align-items-center justify-content-between px-3 py-3">
    <span class="fw-bold fs-4"><i class="fas fa-user-shield me-2"></i>Admin</span>
    <button class="btn btn-sm btn-outline-light d-md-none" id="sidebarCloseBtn" onclick="closeAdminSidebar()"><i class="fas fa-times"></i></button>
  </div>
  <nav class="nav flex-column px-2">
    <a class="nav-link text-white sidebar-link" href="#dashboard-section" onclick="if(window.innerWidth<992) closeAdminSidebar()"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a>
    <a class="nav-link text-white sidebar-link" href="#riders" onclick="if(window.innerWidth<992) closeAdminSidebar()"><i class="fas fa-users me-2"></i>Riders</a>
    <a class="nav-link text-white sidebar-link" href="#providers" onclick="if(window.innerWidth<992) closeAdminSidebar()"><i class="fas fa-user-tie me-2"></i>Providers</a>
    <a class="nav-link text-white sidebar-link" href="#bookings" onclick="if(window.innerWidth<992) closeAdminSidebar()">
      <i class="fas fa-book-open me-2"></i>Bookings
      {% if pending_approvals_count > 0 %}
        <span class="badge bg-danger ms-2 align-middle">{{ pending_approvals_count }}</span>
      {% endif %}
    </a>
    <a class="nav-link text-white sidebar-link" href="#earnings" onclick="if(window.innerWidth<992) closeAdminSidebar()"><i class="fas fa-wallet me-2"></i>Earnings</a>
    <a class="nav-link text-white sidebar-link" href="{% url 'review_documents' %}" onclick="if(window.innerWidth<992) closeAdminSidebar()">
      <i class="fas fa-file-alt me-2"></i>Document Verification
      {% if pending_documents|length > 0 %}
        <span class="badge bg-warning ms-2 align-middle">{{ pending_documents|length }}</span>
      {% endif %}
    </a>
    <a class="nav-link text-white sidebar-link" href="{% url 'admin_feedback_list' %}" onclick="if(window.innerWidth<992) closeAdminSidebar()"><i class="fas fa-envelope me-2"></i>Contact Messages</a>
    <a class="nav-link text-white sidebar-link" href="#analysis-section" onclick="if(window.innerWidth<992) closeAdminSidebar()"><i class="bi bi-bar-chart-fill me-2"></i>Analysis</a>
    <a class="nav-link text-white sidebar-link" href="{% url 'logout' %}" onclick="if(window.innerWidth<992) closeAdminSidebar()"><i class="fas fa-sign-out-alt me-2"></i>Logout</a>
  </nav>
  <div class="sidebar-profile text-center mt-auto mb-4 px-3">
    <img id="sidebarProfileImage" src="{% if request.user.profile_image %}{{ request.user.profile_image.url }}{% else %}https://api.dicebear.com/7.x/avataaars/svg?seed={{ request.user.username }}{% endif %}"
         alt="Profile" class="rounded-circle mb-2 open-profile-modal" style="width:60px; height:60px; object-fit:cover; cursor:pointer;">
    <div id="sidebarUsername" class="fw-semibold">{{ request.user.username }}</div>
    <div id="sidebarEmail" class="text-muted small">{{ request.user.email }}</div>
    <div id="sidebarMobile" class="text-muted small">{{ request.user.mobile_number }}</div>
  </div>
</div>
<div id="sidebarOverlay" class="sidebar-overlay d-md-none"></div>

<!-- Removed old jQuery-based profile modal and script; using admin modal and fetch API below -->

<!-- Removed horizontal navbar for dashboards as requested -->

<!-- Main Dashboard Content -->
<div class="main-content-with-sidebar dashboard-content">
  <div class="d-flex justify-content-between align-items-center p-4" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; margin: 1rem; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
    <!-- Section Header -->
    <div>
      <div style="
        display: inline-block;
        padding: 1.5rem 2.5rem;
        border-radius: 25px;
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        color: white;
        font-size: 1.6rem;
        font-weight: bold;
        box-shadow: 0 8px 32px rgba(116, 185, 255, 0.3);
        position: relative;
        overflow: hidden;
      ">
        <i class="fas fa-shield-check me-3"></i>Welcome, {{ request.user.username }} to Admin Dashboard
        <div style="
          position: absolute;
          top: 0;
          right: 0;
          width: 100px;
          height: 100px;
          background: linear-gradient(45deg, rgba(255,255,255,0.1), transparent);
          border-radius: 50%;
          transform: translate(30px, -30px);
        "></div>
      </div>
    </div>
    <!-- Profile and Logout -->
    <div class="d-flex align-items-center mb-3">
     
    </div>
  </div>

  <div class="container-xxl">
    <h2 class="text-center mb-5 fw-bold text-primary">
     
    </h2>

    <!-- Filters removed from dashboard as per request -->

    <!-- Summary Cards -->
    <div class="row g-4 mb-4 mx-1">
      <div class="col-md-3 col-12">
        <div class="card summary-card h-100 border-0 text-center" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
          <div class="card-body py-4 d-flex flex-column align-items-center justify-content-center">
            <div class="icon-circle mb-3" style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);"><i class="fas fa-users"></i></div>
            <h6 class="fw-bold text-dark mb-1">Total Riders</h6>
            <h2 class="fw-bold mb-0 text-gradient-blue">{{ riders|length }}</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-12">
        <div class="card summary-card h-100 border-0 text-center" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
          <div class="card-body py-4 d-flex flex-column align-items-center justify-content-center">
            <div class="icon-circle mb-3" style="background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);"><i class="fas fa-user-tie"></i></div>
            <h6 class="fw-bold text-dark mb-1">Vehicle Providers</h6>
            <h2 class="fw-bold mb-0 text-gradient-teal">{{ vehicle_providers|length }}</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-12">
        <div class="card summary-card h-100 border-0 text-center" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
          <div class="card-body py-4 d-flex flex-column align-items-center justify-content-center">
            <div class="icon-circle mb-3" style="background: linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%);"><i class="fas fa-bicycle"></i></div>
            <h6 class="fw-bold text-dark mb-1">E-bikes</h6>
            <h2 class="fw-bold mb-0 text-gradient-orange">{{ ebikes|length }}</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-12">
        <div class="card summary-card h-100 border-0 text-center" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
          <div class="card-body py-4 d-flex flex-column align-items-center justify-content-center">
            <div class="icon-circle mb-3" style="background: linear-gradient(135deg, #e17055 0%, #d63031 100%);"><i class="fas fa-book-open"></i></div>
            <h6 class="fw-bold text-dark mb-1">Bookings</h6>
            <h2 class="fw-bold mb-0 text-gradient-red">{{ bookings|length }}</h2>
          </div>
        </div>
      </div>
    </div>

    

    <!-- Analytics Charts Row: Side by Side -->
    <div class="row mb-4 mx-1" id="analysis-section">
      <div class="col-md-4 col-12 mb-3">
        <div class="card card-glass admin-analytics-card mb-4">
          <div class="card-header fw-semibold header-gradient-blue">
            <i class="fas fa-chart-line me-2"></i>Bookings Per Month
          </div>
          <div class="card-body d-flex justify-content-center align-items-center" style="background: transparent;">
            <canvas id="bookingsLineChart" width="220" height="130" style="max-width:220px; margin:0 auto;"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-4 col-12 mb-3">
        <div class="card card-glass admin-analytics-card mb-4">
          <div class="card-header fw-semibold header-gradient-teal">
            <i class="fas fa-chart-pie me-2"></i>Booking Status
          </div>
          <div class="card-body d-flex justify-content-center align-items-center" style="background: transparent;">
            <canvas id="statusPieChart" width="220" height="130" style="max-width:220px; margin:0 auto;"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-4 col-12 mb-3">
        <div class="card card-glass admin-analytics-card mb-4">
          <div class="card-header fw-semibold header-gradient-orange">
            <i class="fas fa-chart-scatter me-2"></i>Provider Earnings vs Bikes
          </div>
          <div class="card-body d-flex justify-content-center align-items-center" style="background: transparent;">
            <canvas id="providerScatterChart" width="220" height="130" style="max-width:220px; margin:0 auto;"></canvas>
          </div>
        </div>
      </div>
    </div>
    <!-- Chart.js CDN and chart code (inside block content, after canvases) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Stylish Line Chart (Bookings Per Month)
      const chartMonths = {{ chart_months|default:'[]'|safe }};
      const chartCounts = {{ chart_counts|default:'[]'|safe }};
      if (chartMonths.length && chartCounts.length) {
        const lineEl = document.getElementById('bookingsLineChart');
        if (lineEl && typeof lineEl.getContext === 'function') {
        const ctx = lineEl.getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 130);
        gradient.addColorStop(0, 'rgba(54, 162, 235, 0.7)');
        gradient.addColorStop(1, 'rgba(54, 162, 235, 0.1)');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: chartMonths,
            datasets: [{
              label: 'Bookings per Month',
              data: chartCounts,
              fill: true,
              backgroundColor: gradient,
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 3,
              pointBackgroundColor: 'rgba(54, 162, 235, 1)',
              pointRadius: 4,
              tension: 0.4
            }]
          },
          options: {
            responsive: false,
            plugins: {
              legend: { display: false },
              title: { display: false },
              tooltip: {
                backgroundColor: '#fff',
                titleColor: '#222',
                bodyColor: '#222',
                borderColor: '#36a2eb',
                borderWidth: 1
              }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: '#222', font: { weight: 'bold', size: 10 } }
              },
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(54, 162, 235, 0.1)' },
                ticks: { color: '#222', font: { weight: 'bold', size: 10 } }
              }
            }
          }
        });
        }
      }
      // Stylish Pie Chart (Booking Status)
      const statusPieEl = document.getElementById('statusPieChart');
      if (statusPieEl && typeof statusPieEl.getContext === 'function') {
      const statusPieCtx = statusPieEl.getContext('2d');
      const approvedCount = {{ approved_count|default:'0' }};
      const pendingCount = {{ pending_count|default:'0' }};
      new Chart(statusPieCtx, {
        type: 'doughnut',
        data: {
          labels: ['Approved', 'Pending'],
          datasets: [{
            data: [approvedCount, pendingCount],
            backgroundColor: [
              'rgba(40, 167, 69, 0.85)',
              'rgba(255, 193, 7, 0.85)'
            ],
            borderColor: [
              'rgba(40, 167, 69, 1)',
              'rgba(255, 193, 7, 1)'
            ],
            borderWidth: 2,
            hoverOffset: 8
          }]
        },
        options: {
          cutout: '65%',
          responsive: false,
          plugins: {
            legend: { position: 'bottom', labels: { color: '#222', font: { weight: 'bold', size: 10 } } },
            title: { display: false },
            tooltip: {
              backgroundColor: '#fff',
              titleColor: '#222',
              bodyColor: '#222',
              borderColor: '#28a745',
              borderWidth: 1
            }
          }
        }
      });
      }
      // Stylish Scatter Chart (Provider Earnings vs Number of Bikes)
      const scatterEl = document.getElementById('providerScatterChart');
      if (scatterEl && typeof scatterEl.getContext === 'function') {
      const scatterCtx = scatterEl.getContext('2d');
      const scatterData = [
        {x: 2, y: 15000},
        {x: 4, y: 32000},
        {x: 1, y: 8000},
        {x: 3, y: 21000},
        {x: 5, y: 40000}
      ];
      new Chart(scatterCtx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: '',
            data: scatterData,
            backgroundColor: 'rgba(255, 99, 132, 0.85)',
            borderColor: 'rgba(255, 99, 132, 1)',
            pointRadius: 7,
            pointHoverRadius: 10,
            pointStyle: 'rectRounded'
          }]
        },
        options: {
          responsive: false,
          plugins: {
            legend: { display: false },
            title: { display: false },
            tooltip: {
              backgroundColor: '#fff',
              titleColor: '#222',
              bodyColor: '#222',
              borderColor: '#ff6384',
              borderWidth: 1
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Number of Bikes', color: '#222', font: { weight: 'bold', size: 10 } },
              beginAtZero: true,
              grid: { color: 'rgba(255, 99, 132, 0.1)' },
              ticks: { color: '#222', font: { weight: 'bold', size: 10 } }
            },
            y: {
              title: { display: true, text: 'Earnings (₹)', color: '#222', font: { weight: 'bold', size: 10 } },
              beginAtZero: true,
              grid: { color: 'rgba(255, 99, 132, 0.1)' },
              ticks: { color: '#222', font: { weight: 'bold', size: 10 } }
            }
          }
        }
      });
      }
    </script>

    <!-- Profile Edit Modal (Admin Only) -->
    <div class="modal fade" id="adminProfileModal" tabindex="-1" aria-labelledby="adminProfileModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="adminProfileModalLabel">Edit Profile</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="adminProfileModalBody">
            <div class="text-center py-4" id="adminProfileModalLoader">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Minimal AJAX modal specifically for Admin Dashboard
      (function(){
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }

        const modalEl = document.getElementById('adminProfileModal');
        const modalBody = document.getElementById('adminProfileModalBody');
        const modalLoader = document.getElementById('adminProfileModalLoader');
        const triggers = document.querySelectorAll('.open-profile-modal');

        async function openAdminProfileModal(e){
          if (e) e.preventDefault();
          if (!modalEl) return;
          const modal = new bootstrap.Modal(modalEl);
          modalBody.innerHTML = modalLoader ? modalLoader.outerHTML : '';
          modal.show();
          try {
            const resp = await fetch("{% url 'profile_update' %}", { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            const data = await resp.json();
            if (data.success && data.html) {
              modalBody.innerHTML = data.html;
              const form = document.getElementById('profile-update-form');
              if (form) {
                form.addEventListener('submit', async function (ev) {
                  ev.preventDefault();
                  const formData = new FormData(form);
                  const btn = form.querySelector('button[type="submit"]');
                  if (btn) btn.disabled = true;
                  try {
                    const r = await fetch(form.getAttribute('action'), {
                      method: 'POST',
                      headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken') },
                      body: formData
                    });
                    if (r.ok) {
                      const ok = await r.json();
                      // Update sidebar values in-place
                      const uEl = document.getElementById('sidebarUsername');
                      const eEl = document.getElementById('sidebarEmail');
                      const mEl = document.getElementById('sidebarMobile');
                      const imgEl = document.getElementById('sidebarProfileImage');
                      if (uEl && ok.username) uEl.textContent = ok.username;
                      if (eEl && ok.email) eEl.textContent = ok.email;
                      if (mEl && ok.mobile_number) mEl.textContent = ok.mobile_number;
                      if (imgEl && ok.profile_image_url) imgEl.src = ok.profile_image_url;
                      modalBody.insertAdjacentHTML('afterbegin', `<div class="alert alert-success">${ok.message || 'Profile updated successfully!'}</div>`);
                      setTimeout(() => { const inst = bootstrap.Modal.getInstance(modalEl); if (inst) inst.hide(); }, 700);
                    } else {
                      const err = await r.json();
                      modalBody.innerHTML = err.html || '<div class="alert alert-danger">Failed to update profile.</div>';
                      // Re-bind after replacing body
                      openAdminProfileModal(); // reloads form and rebinds
                    }
                  } catch (ex) {
                    modalBody.insertAdjacentHTML('afterbegin', '<div class="alert alert-danger">Unexpected error. Please try again.</div>');
                  } finally {
                    if (btn) btn.disabled = false;
                  }
                });
              }
            } else {
              modalBody.innerHTML = '<div class="alert alert-danger">Failed to load form.</div>';
            }
          } catch (e) {
            modalBody.innerHTML = '<div class="alert alert-danger">Failed to load form.</div>';
          }
        }

        if (triggers.length) {
          triggers.forEach(t => t.addEventListener('click', openAdminProfileModal));
        }
      })();
    </script>

    <!-- Earnings -->
    <div class="row mb-4 mx-1">
      <div class="col-md-6 mb-3">
        <div class="card text-center" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
          <div class="card-body py-4">
            <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3" style="width: 80px; height: 80px; background: linear-gradient(135deg, #00b894, #00cec9);">
              <i class="fas fa-wallet fa-2x text-white"></i>
            </div>
            <h5 class="card-title mt-2 fw-bold text-dark">Providers Earnings</h5>
            <h2 class="text-dark fw-bold" style="background: linear-gradient(135deg, #00b894, #00cec9); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">₹{{ total_providers_earnings }}</h2>
          </div>
        </div>
      </div>
      <div class="col-md-6 mb-3">
        <div class="card text-center" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
          <div class="card-body py-4">
            <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3" style="width: 80px; height: 80px; background: linear-gradient(135deg, #e17055, #d63031);">
              <i class="fas fa-coins fa-2x text-white"></i>
            </div>
            <h5 class="card-title mt-2 fw-bold text-dark">Admin Profit</h5>
            <h2 class="text-gradient-red fw-bold">₹{{ platform_charges }}</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- Riders and Providers Tables -->
    <div class="row mx-1" id="riders">
      <div class="col-12 mb-4">
        <div class="card card-glass">
          <div class="card-header fw-semibold header-gradient-blue">
            <i class="fas fa-users me-2"></i>Riders
          </div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle modern-table">
              <thead class="table-dark">
                <tr>
                  <th>Profile</th>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for rider in riders %}
                <tr>
                  <td>
                    <img src="{% if rider.profile_image %}{{ rider.profile_image.url }}{% else %}https://api.dicebear.com/7.x/avataaars/svg?seed={{ rider.username }}{% endif %}"
                         alt="{{ rider.username }}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid #eee;" />
                  </td>
                  <td>{{ rider.username }}</td>
                  <td>{{ rider.email }}</td>
                  <td>
                    <a
                      href="{% url 'delete_user' rider.id %}"
                      class="btn btn-outline-danger btn-sm"
                    >
                      <i class="bi bi-trash"></i>
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-12 mb-4" id="providers">
        <div class="card card-glass">
          <div class="card-header fw-semibold header-gradient-teal">
            <i class="fas fa-user-tie me-2"></i>Vehicle Providers
          </div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle modern-table">
              <thead class="table-dark">
                <tr>
                  <th>Profile</th>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Bike Names</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for provider in vehicle_providers %}
                <tr>
                  <td>
                    <img src="{% if provider.profile_image %}{{ provider.profile_image.url }}{% else %}https://api.dicebear.com/7.x/avataaars/svg?seed={{ provider.username }}{% endif %}"
                         alt="{{ provider.username }}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid #eee;" />
                  </td>
                  <td>{{ provider.username }}</td>
                  <td>{{ provider.email }}</td>
                  <td style="min-width: 220px; white-space: normal;">
                    {% for ebike in provider.ebikes.all %}
                      <span style="display: inline-flex; align-items: center; margin-right: 12px; margin-bottom: 4px;">
                        {% if ebike.image %}
                          <img src="{{ ebike.image.url }}" alt="{{ ebike.name }}" style="width: 40px; height: 28px; object-fit: cover; border-radius: 6px; margin-right: 4px;" />
                        {% else %}
                          <img src="https://api.dicebear.com/7.x/icons/svg?seed={{ ebike.name }}" alt="{{ ebike.name }}" style="width: 40px; height: 28px; object-fit: cover; border-radius: 6px; margin-right: 4px;" />
                        {% endif %}
                        <span style="font-size: 0.97em; color: #222;">{{ ebike.name }}</span>
                      </span>
                    {% endfor %}
                  </td>
                  <td>
                    <a href="{% url 'admin_provider_detail' provider.id %}" class="btn btn-outline-primary btn-sm me-1">
                      <i class="bi bi-eye"></i> View
                    </a>
                    <a href="{% url 'delete_user' provider.id %}" class="btn btn-outline-danger btn-sm">
                      <i class="bi bi-trash"></i>
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Earnings Table -->
    <div class="row mx-1" id="earnings">
      <div class="col-md-12 mb-4">
        <div class="card card-glass">
          <div class="card-header fw-semibold header-gradient-orange">
            <i class="fas fa-coins me-2"></i>Provider Earnings
          </div>
          <div class="card-body">
            <table class="table table-hover align-middle modern-table">
              <thead class="table-dark">
                <tr>
                  <th>Profile</th>
                  <th>Provider</th>
                  <th>Bike Names</th>
                  <th>Total Earnings</th>
                </tr>
              </thead>
              <tbody>
                {% for provider_earnings in providers_earnings %}
                <tr>
                  <td>
                    <img src="{% if provider_earnings.profile_image %}{{ provider_earnings.profile_image.url }}{% else %}https://api.dicebear.com/7.x/avataaars/svg?seed={{ provider_earnings.username }}{% endif %}"
                         alt="{{ provider_earnings.username }}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid #eee;" />
                  </td>
                  <td>{{ provider_earnings.username }}</td>
                  <td style="min-width: 220px; white-space: normal;">
                    {% for bike in provider_earnings.bikes %}
                      <span style="display: inline-flex; align-items: center; margin-right: 12px; margin-bottom: 4px;">
                        {% if bike.image %}
                          <img src="{{ bike.image.url }}" alt="{{ bike.name }}" style="width: 40px; height: 28px; object-fit: cover; border-radius: 6px; margin-right: 4px;" />
                        {% else %}
                          <img src="https://api.dicebear.com/7.x/icons/svg?seed={{ bike.name }}" alt="{{ bike.name }}" style="width: 40px; height: 28px; object-fit: cover; border-radius: 6px; margin-right: 4px;" />
                        {% endif %}
                        <span style="font-size: 0.97em; color: #222;">{{ bike.name }}</span>
                      </span>
                    {% endfor %}
                  </td>
                  <td>₹{{ provider_earnings.total_earnings }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Document Verification Section -->
    {% if pending_documents or pending_providers %}
    <div class="row mb-4 mx-1" id="document-verification">
      <div class="col-12">
        <div class="card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
          <div class="card-header fw-semibold" style="background: linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%); color: white; border-radius: 20px 20px 0 0;">
            <i class="fas fa-file-alt me-2"></i>Document Verification
            {% if pending_documents|length > 0 %}
              <span class="badge bg-danger ms-2">{{ pending_documents|length }} Pending</span>
            {% endif %}
          </div>
          <div class="card-body">
            <div class="row">
              <!-- Pending Documents -->
              {% if pending_documents %}
                <div class="col-md-6 mb-3">
                  <h6 class="text-warning mb-3">
                    <i class="fas fa-clock me-1"></i>Pending Document Reviews
                  </h6>
                  {% for document in pending_documents|slice:":3" %}
                    <div class="card border-warning mb-2">
                      <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                          <div>
                            <h6 class="mb-1">{{ document.get_document_type_display }}</h6>
                            <small class="text-muted">Provider: {{ document.provider.username }}</small>
                            <br>
                            <small class="text-muted">{{ document.uploaded_at|date:"M d, Y H:i" }}</small>
                          </div>
                          <div>
                            <a href="{% url 'verify_document' document.id %}" class="btn btn-warning btn-sm">
                              <i class="fas fa-eye me-1"></i>Review
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                  {% if pending_documents|length > 3 %}
                    <div class="text-center">
                      <a href="{% url 'review_documents' %}" class="btn btn-outline-warning">
                        View All {{ pending_documents|length }} Documents
                      </a>
                    </div>
                  {% endif %}
                </div>
              {% endif %}

              <!-- Pending Provider Verifications -->
              {% if pending_providers %}
                <div class="col-md-6 mb-3">
                  <h6 class="text-info mb-3">
                    <i class="fas fa-user-check me-1"></i>Unverified Providers
                  </h6>
                  {% for provider in pending_providers|slice:":3" %}
                    <div class="card border-info mb-2">
                      <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                          <div>
                            <h6 class="mb-1">{{ provider.username }}</h6>
                            <small class="text-muted">Email: {{ provider.email }}</small>
                            <br>
                            <small class="text-muted">Joined: {{ provider.date_joined|date:"M d, Y" }}</small>
                          </div>
                          <div>
                            <a href="{% url 'verify_provider' provider.id %}" class="btn btn-info btn-sm">
                              <i class="fas fa-check me-1"></i>Verify
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                  {% if pending_providers|length > 3 %}
                    <div class="text-center">
                      <span class="text-muted">+{{ pending_providers|length|add:"-3" }} more providers</span>
                    </div>
                  {% endif %}
                </div>
              {% endif %}
            </div>
            
            <div class="text-center mt-3">
              <a href="{% url 'review_documents' %}" class="btn btn-primary">
                <i class="fas fa-file-alt me-1"></i>Go to Document Review
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Bookings Table -->
    <div class="row mx-1" id="bookings">
      <div class="col-12 mb-4">
        <div class="card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
          <div class="card-header fw-semibold" style="background: linear-gradient(135deg, #e17055 0%, #d63031 100%); color: white; border-radius: 20px 20px 0 0;">
            <i class="fas fa-book-open me-2"></i>Bookings
          </div>
          <div class="card-body">
            <div class="row g-3">
              {% for booking in bookings %}
              <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100">
                  <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                      <img src="{% if booking.rider.profile_image %}{{ booking.rider.profile_image.url }}{% else %}https://api.dicebear.com/7.x/avataaars/svg?seed={{ booking.rider.username }}{% endif %}"
                           alt="{{ booking.rider.username }}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; margin-right: 8px;" />
                      <h5 class="fw-bold text-primary mb-0">
                        <i class="bi bi-person"></i> {{ booking.rider.username }}
                      </h5>
                    </div>
                      <p class="mb-1">
                        {% if booking.ebike.image %}
                          <img src="{{ booking.ebike.image.url }}" alt="{{ booking.ebike.name }}" style="width: 40px; height: 28px; object-fit: cover; border-radius: 6px; margin-right: 4px;" />
                        {% else %}
                          <img src="https://api.dicebear.com/7.x/icons/svg?seed={{ booking.ebike.name }}" alt="{{ booking.ebike.name }}" style="width: 40px; height: 28px; object-fit: cover; border-radius: 6px; margin-right: 4px;" />
                        {% endif %}
                        {{ booking.ebike.name }}
                      </p>
                      <p class="mb-1"><i class="bi bi-calendar"></i> {{ booking.start_date }} → {{ booking.end_date }}</p>
                      <span class="badge {% if booking.is_approved %}bg-success{% else %}bg-warning text-dark{% endif %}">
                        {% if booking.is_approved %}Approved{% else %}Pending{% endif %}
                      </span>
                      <span class="badge {% if booking.is_paid %}bg-success{% else %}bg-warning text-dark{% endif %} ms-2">
                        {% if booking.is_paid %}Paid{% else %}Payment Pending{% endif %}
                      </span>
                      <div class="mt-2">
                        {% if not booking.is_approved %}
                          <a href="{% url 'approve_booking' booking.id %}" class="btn btn-outline-success btn-sm me-2"><i class="bi bi-check-circle"></i></a>
                        {% endif %}
                        <a href="{% url 'reject_booking' booking.id %}?next={% url 'admin_dashboard' %}" class="btn btn-outline-danger btn-sm"><i class="bi bi-x-circle"></i></a>
                        <a href="{% url 'cancel_booking' booking.id %}?next={% url 'admin_dashboard' %}" class="btn btn-outline-danger btn-sm ms-1"><i class="bi bi-trash"></i> Cancel</a>
                      </div>
                    </div>
                  </div>
                </div>
                {% empty %}
                  <div class="col-12 text-center text-muted">No bookings found.</div>
                {% endfor %}
              </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Reviews Section -->
    <div class="row mx-1 mt-3" id="recent-feedback">
      <div class="col-12">
        <div class="card shadow-soft border-0" style="border-radius: 20px;">
          <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="mb-0"><i class="fas fa-star-half-alt me-2"></i>Recent Reviews</h5>
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-primary">{{ recent_feedback|length }} New</span>
              <!-- Reviews are from public site; Contact Messages managed in separate page -->
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover align-middle modern-table mb-0">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Rating</th>
                    <th>Message</th>
                    <th>Received</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in recent_feedback %}
                  <tr>
                    <td class="fw-semibold">{{ item.name }}</td>
                    <td>
                      {% for _ in "12345"|slice:":" %}{% endfor %}
                      <span class="badge bg-info">{{ item.rating }}/5</span>
                    </td>
                    <td style="max-width: 420px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ item.message }}</td>
                    <td><small class="text-muted">{{ item.created_at|date:"M d, Y H:i" }}</small></td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="4" class="text-center text-muted">No reviews yet.</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<style>
  body {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    font-family: "Segoe UI", sans-serif;
    color: #333;
  }

  .icon-large {
    font-size: 2.5rem;
  }

  .summary-card {
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease;
  }

  .summary-card:hover {
    transform: translateY(-5px);
  }

  .card-title {
    font-size: 1rem;
    font-weight: 600;
  }

  .table th,
  .table td {
    text-align: center;
  }

  .table-hover tbody tr:hover {
    background-color: #f1f9ff;
  }

  .btn-sm i {
    font-size: 1rem;
  }
  .summary-card {
    border-radius: 1rem !important;
    box-shadow: 0 2px 8px rgba(30,60,114,0.08);
    transition: transform 0.2s, box-shadow 0.2s;
    min-height: 180px;
    margin-bottom: 0;
  }
  .summary-card:hover {
    transform: translateY(-4px) scale(1.03);
    box-shadow: 0 8px 32px rgba(30,60,114,0.15);
  }
  .icon-circle {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .dashboard-sidebar .sidebar-profile img {
    border: 3px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .dashboard-sidebar .sidebar-profile {
    margin-top: auto;
    padding-top: 1.5rem;
    border-top: 1.5px solid #2a5298;
  }
  .dashboard-sidebar .sidebar-profile .fw-semibold {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }
  .dashboard-sidebar .btn-outline-danger {
    border-radius: 8px;
    font-weight: 500;
  }
  .dashboard-sidebar .nav-link {
    padding: 0.75rem 1.2rem;
    border-radius: 8px;
    margin-bottom: 0.2rem;
    transition: background 0.2s, color 0.2s;
    font-size: 1.08rem;
    font-weight: 500;
    position: relative;
    color: #fff;
  }
  .dashboard-sidebar .nav-link.active, .dashboard-sidebar .nav-link:hover {
    background: #1e3c72;
    color: #fff;
    text-decoration: none;
    font-weight: 700;
  }
  .dashboard-sidebar {
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    width: 220px;
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
    z-index: 1200;
    transition: left 0.3s;
    box-shadow: 2px 0 8px rgba(30,60,114,0.08);
    border-right: 1.5px solid #2a5298;
    overflow-y: auto;
  }
  .dashboard-content {
    margin-left: 220px;
    transition: margin-left 0.3s;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh;
  }
  @media (max-width: 991px) {
    .dashboard-sidebar { left: -220px; }
    .dashboard-sidebar.open {
      left: 0;
    }
    .dashboard-content { margin-left: 0 !important; }
  }
  .dashboard-sidebar-toggle {
    position: fixed;
    top: 18px;
    left: 18px;
    background: #1e3c72;
    color: #fff;
    border: none;
    border-radius: 6px;
    width: 36px;
    height: 36px;
    z-index: 1100;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
  }
  @media (min-width: 992px) {
    .dashboard-sidebar-toggle { display: none; }
  }
  .sidebar {
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    width: 220px;
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
    z-index: 1200;
    transition: left 0.3s;
    box-shadow: 2px 0 8px rgba(30,60,114,0.08);
    border-right: 1.5px solid #2a5298;
    overflow-y: auto;
  }
  .sidebar-header {
    border-bottom: 1.5px solid #2a5298;
  }
  .sidebar-profile {
    margin-top: auto;
    padding-top: 1.5rem;
    border-top: 1.5px solid #2a5298;
  }
  .sidebar-profile img {
    border: 3px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .sidebar-link {
    padding: 0.75rem 1.2rem;
    border-radius: 8px;
    margin-bottom: 0.2rem;
    transition: background 0.2s, color 0.2s;
    font-size: 1.08rem;
    font-weight: 500;
    position: relative;
  }
  .sidebar-link:hover, .sidebar-link.active {
    background: #1e3c72;
    color: #fff;
    text-decoration: none;
    font-weight: 700;
  }
  .sidebar-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(30,60,114,0.25);
    z-index: 1040;
    display: none;
  }
  .main-content-with-sidebar {
    margin-left: 220px;
    transition: margin-left 0.3s;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh;
  }
  @media (max-width: 991.98px) {
    .sidebar {
      left: -220px;
      width: 220px;
    }
    .sidebar.open {
      left: 0;
    }
    .main-content-with-sidebar {
      margin-left: 0;
    }
    .sidebar-overlay.show {
      display: block;
    }
  }
</style>


<!-- Profile Edit Modal -->
<div class="modal fade" id="profileEditModal" tabindex="-1" aria-labelledby="profileEditModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" enctype="multipart/form-data" action="{% url 'profile_update' %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="profileEditModalLabel">Edit Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 text-center">
            <img src="{% if request.user.profile_image %}{{ request.user.profile_image.url }}{% else %}https://api.dicebear.com/7.x/avataaars/svg?seed={{ request.user.username }}{% endif %}"
                 alt="Profile Image" class="rounded-circle mb-2" style="width: 80px; height: 80px; object-fit: cover;">
          </div>
          <div class="mb-3">
            <label for="id_username" class="form-label">Username</label>
            <input type="text" name="username" class="form-control" id="id_username" value="{{ request.user.username }}" required>
          </div>
          <div class="mb-3">
            <label for="id_profile_image" class="form-label">Profile Image</label>
            <input type="file" name="profile_image" class="form-control" id="id_profile_image">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endblock %}
<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
</script>

<script>
// Sidebar toggle for mobile and desktop (stable version)
document.addEventListener('DOMContentLoaded', function() {
  const sidebar = document.getElementById('sidebar');
  let sidebarOverlay = document.getElementById('sidebarOverlay');
  const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');
  const sidebarToggle = document.getElementById('sidebarToggle');

  // Ensure overlay exists
  if (!sidebarOverlay) {
    sidebarOverlay = document.createElement('div');
    sidebarOverlay.id = 'sidebarOverlay';
    sidebarOverlay.className = 'sidebar-overlay d-md-none';
    document.body.appendChild(sidebarOverlay);
  }

  function openSidebar() {
    if (sidebar) {
      sidebar.classList.add('open');
      if (sidebarOverlay) sidebarOverlay.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
  }

  function closeSidebar() {
    if (sidebar) {
      sidebar.classList.remove('open');
      if (sidebarOverlay) sidebarOverlay.classList.remove('show');
      document.body.style.overflow = '';
    }
  }

  // Expose a global closer for inline X button
  window.closeAdminSidebar = closeSidebar;

  if (sidebarCloseBtn) sidebarCloseBtn.onclick = closeSidebar;
  if (sidebarOverlay) sidebarOverlay.onclick = closeSidebar;
  if (sidebarToggle) {
    sidebarToggle.onclick = function () {
      console.debug('[AdminSidebar] toggle clicked');
      if (window.innerWidth < 992) {
        openSidebar();
      } else if (sidebar) {
        sidebar.classList.toggle('collapsed');
        const mainContent = document.querySelector('.main-content-with-sidebar') || document.querySelector('.dashboard-content');
        if (mainContent) mainContent.classList.toggle('collapsed');
      }
    };
  }

  // Global fallback for inline onclick on the button
  window.handleSidebarToggle = function() {
    console.debug('[AdminSidebar] inline handleSidebarToggle');
    if (window.innerWidth < 992) {
      openSidebar();
    } else if (sidebar) {
      sidebar.classList.toggle('collapsed');
      const mainContent = document.querySelector('.main-content-with-sidebar') || document.querySelector('.dashboard-content');
      if (mainContent) mainContent.classList.toggle('collapsed');
    }
  };

  // Smooth scroll for sidebar links + close on mobile after navigation
  const sidebarLinks = document.querySelectorAll('.sidebar-link');
  sidebarLinks.forEach(link => {
    link.onclick = function(e) {
      const href = this.getAttribute('href');
      const isAnchor = href && href.startsWith('#');
      if (window.innerWidth < 992) closeSidebar();
      if (isAnchor) {
        e.preventDefault();
        const target = document.querySelector(href);
        // Scroll after sidebar transition to avoid jank
        setTimeout(() => {
          if (target) window.scrollTo({ top: target.offsetTop - 20, behavior: 'smooth' });
        }, 200);
      }
    };
  });
  // Extra safety: if hash changes, ensure sidebar is closed on mobile
  window.addEventListener('hashchange', function() {
    if (window.innerWidth < 992) closeSidebar();
  });

  // Event delegation: close sidebar on any link click within sidebar nav
  const sidebarNav = document.querySelector('#sidebar nav');
  if (sidebarNav) {
    sidebarNav.addEventListener('click', function(e) {
      const a = e.target.closest('a');
      if (a && window.innerWidth < 992) {
        // Let default navigation happen, but close the panel immediately
        closeSidebar();
      }
    });
  }

  // Click outside to close on mobile
  document.addEventListener('click', function(e) {
    if (window.innerWidth < 992) {
      const toggleBtn = document.getElementById('sidebarToggle');
      if (
        sidebar &&
        sidebar.classList.contains('open') &&
        !sidebar.contains(e.target) &&
        !(toggleBtn && toggleBtn.contains(e.target))
      ) {
        closeSidebar();
      }
    }
  });

  window.addEventListener('resize', function () {
    if (window.innerWidth >= 992) closeSidebar();
  });
});
</script>

